<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>PLANT ARCHIVE | JS KIM</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --primary:#0A2647; --accent:#1597BB; --green:#27ae60; --red:#E74C3C; --orange:#D35400; }
        body { background:#f0f2f5; font-family:'Pretendard','Segoe UI',sans-serif; min-height:100vh; margin:0; }

        /* ìƒë‹¨ ë°” */
        .top-bar { background:var(--primary); padding:16px 28px; display:flex; align-items:center; justify-content:space-between; box-shadow:0 3px 15px rgba(0,0,0,.25); }
        .top-bar .brand { font-size:.95rem; font-weight:900; color:#FFD700; letter-spacing:.05em; }
        .top-bar .sub   { font-size:.65rem; color:rgba(255,255,255,.5); margin-top:2px; }
        .btn-input-top  { background:var(--accent); color:white; border:none; padding:9px 18px; border-radius:20px; font-weight:900; font-size:.78rem; cursor:pointer; transition:background .2s; display:flex; align-items:center; gap:7px; }
        .btn-input-top:hover { background:#0d86a8; }

        /* í˜ì´ì§€ */
        .page-wrap { max-width:820px; margin:32px auto; padding:0 20px 80px; }

        /* í•„í„° ì¹´ë“œ */
        .filter-card { background:white; border-radius:14px; padding:20px 22px; box-shadow:0 6px 22px rgba(0,0,0,.07); margin-bottom:20px; }
        .filter-card select { border:1.5px solid #e2e8f0; border-radius:9px; padding:10px 14px; font-size:.84rem; color:#333; font-weight:600; width:100%; transition:border-color .2s; }
        .filter-card select:focus { outline:none; border-color:var(--accent); box-shadow:none; }
        .filter-card select:disabled { background:#f5f7fa; color:#bbb; }
        .btn-refresh { background:var(--primary); color:white; border:none; border-radius:9px; padding:10px 16px; font-weight:700; font-size:.78rem; cursor:pointer; white-space:nowrap; width:100%; transition:opacity .2s; }
        .btn-refresh:hover { opacity:.85; }

        /* ë¡œë”© */
        #loading { text-align:center; padding:55px; display:none; color:#aaa; }
        .spinner { width:30px; height:30px; border:3px solid #e2e8f0; border-top-color:var(--accent); border-radius:50%; animation:spin .7s linear infinite; margin:0 auto 12px; }
        @keyframes spin { to { transform:rotate(360deg) } }

        /* ê²°ê³¼ ì¹´ìš´íŠ¸ */
        .result-count { font-size:.75rem; color:#999; margin-bottom:12px; font-weight:600; }
        .result-count span { color:var(--accent); font-weight:900; }

        /* ì•„ì¹´ì´ë¸Œ ì¹´ë“œ */
        .info-card { background:white; border-radius:14px; padding:26px 28px; box-shadow:0 6px 22px rgba(0,0,0,.07); margin-bottom:16px; border-left:5px solid #dee2e6; }
        .card-sd { border-left-color:var(--red); }
        .card-rc { border-left-color:var(--orange); }
        .card-mn { border-left-color:var(--green); }
        .card-rs { border-left-color:var(--accent); }

        .card-top { display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:16px; }
        .card-company { font-size:1.05rem; font-weight:900; color:var(--primary); }
        .card-date    { font-size:.65rem; color:#bbb; margin-top:3px; }
        .sbadge { display:inline-block; padding:5px 13px; border-radius:20px; font-weight:800; font-size:.75rem; flex-shrink:0; }
        .sb-sd { background:#ffe3e3; color:#c0392b; }
        .sb-rc { background:#fff4e6; color:#d35400; }
        .sb-mn { background:#e8f8f0; color:#1e8449; }
        .sb-rs { background:#e8f0fe; color:#2471a3; }

        .row-item { display:flex; border-bottom:1px solid #f5f5f5; padding:9px 0; align-items:flex-start; }
        .row-item:last-child { border-bottom:none; }
        .rl { width:130px; flex-shrink:0; font-size:.75rem; color:#aaa; font-weight:700; padding-top:2px; }
        .rv { font-size:.88rem; color:#2d3436; font-weight:500; word-break:break-word; }
        .rv.capa { color:var(--accent); font-weight:900; font-size:.98rem; }
        .rv.miss { color:#ccc; font-style:italic; font-size:.8rem; }
        .cmt-box { background:#f8fafc; border-radius:8px; padding:11px 13px; border-left:4px solid #dee2e6; font-size:.78rem; color:#666; line-height:1.65; width:100%; margin-top:4px; }

        /* ë¹ˆ ìƒíƒœ */
        #empty-msg { text-align:center; padding:55px; color:#ccc; font-size:.9rem; }

        /* â”€â”€ ICIS ì…ë ¥ ëª¨ë‹¬ â”€â”€ */
        #overlay { position:fixed; inset:0; background:rgba(5,20,50,.88); z-index:9000; display:none; align-items:center; justify-content:center; backdrop-filter:blur(5px); }
        #overlay.open { display:flex; }
        #modal { width:580px; max-height:92vh; background:white; border-radius:18px; box-shadow:0 24px 70px rgba(0,0,0,.5); display:flex; flex-direction:column; overflow:hidden; animation:mIn .22s ease; }
        @keyframes mIn { from{opacity:0;transform:translateY(18px) scale(.97)} to{opacity:1;transform:none} }

        .mhead { background:var(--primary); color:white; padding:18px 22px; display:flex; justify-content:space-between; align-items:center; flex-shrink:0; }
        .mhead h3 { margin:0; font-size:.98rem; font-weight:900; }
        .mhead .ver { background:var(--accent); font-size:.6rem; padding:3px 9px; border-radius:9px; font-weight:900; }

        .mbody { padding:20px 22px; overflow-y:auto; flex:1; }
        .mlabel { font-size:.65rem; font-weight:900; color:#aaa; text-transform:uppercase; letter-spacing:.1em; display:block; margin-bottom:7px; }
        #icis-input { width:100%; height:200px; border:2px solid #e2e8f0; border-radius:10px; padding:13px; font-size:.78rem; font-family:'Segoe UI',monospace; resize:vertical; line-height:1.72; color:#333; transition:border-color .2s; box-sizing:border-box; }
        #icis-input:focus { outline:none; border-color:var(--accent); }
        #icis-input::placeholder { color:#c5c9d0; line-height:1.9; }

        /* íŒŒì‹± ê²°ê³¼ */
        #pv-wrap { display:none; margin-top:16px; border:1.5px solid #e2e8f0; border-radius:12px; overflow:hidden; }
        .pv-head { background:#f0f5f9; padding:10px 14px; font-size:.67rem; font-weight:900; color:var(--primary); border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center; }
        .pbadge { font-size:.63rem; padding:3px 9px; border-radius:7px; font-weight:900; }
        .pb-ok   { background:#d4efdf; color:#1e8449; }
        .pb-warn { background:#fdebd0; color:#d35400; }
        .pg { display:grid; grid-template-columns:1fr 1fr; }
        .pf { padding:10px 14px; border-bottom:1px solid #f2f2f2; border-right:1px solid #f2f2f2; }
        .pf:nth-child(2n) { border-right:none; }
        .pf.full { grid-column:1/-1; border-right:none; }
        .pf.capa-ok   { background:linear-gradient(135deg,#eaf5fb,#d4edf5); border:1.5px solid var(--accent); }
        .pf.capa-miss { background:#fff7f7; border:1.5px solid #f5c6c6; }
        .pl { font-size:.56rem; color:#bbb; text-transform:uppercase; font-weight:800; letter-spacing:.08em; }
        .pv { font-size:.84rem; font-weight:700; color:#1a1a2e; margin-top:3px; word-break:break-word; }
        .pv.hi { color:var(--accent); }
        .pv.er { color:var(--red); }
        .pv-cmt { background:#f8fafc; border-radius:7px; padding:10px 12px; border-left:4px solid #dee2e6; font-size:.76rem; color:#666; line-height:1.62; margin-top:4px; }
        .spill { display:inline-block; padding:3px 10px; border-radius:14px; font-size:.69rem; font-weight:800; }
        .sp-sd { background:#ffe3e3; color:#c0392b; }
        .sp-rc { background:#fff4e6; color:#d35400; }
        .sp-mn { background:#e8f8f0; color:#1e8449; }
        .sp-rs { background:#e8f0fe; color:#2471a3; }

        .mfoot { padding:14px 22px; border-top:1px solid #eee; display:flex; gap:9px; flex-shrink:0; background:#fafafa; }
        .btn-m-parse { flex:1; padding:12px; background:var(--accent); color:white; border:none; border-radius:9px; cursor:pointer; font-weight:900; font-size:.82rem; transition:background .2s; }
        .btn-m-parse:hover { background:#0d86a8; }
        .btn-m-save  { flex:2; padding:12px; background:var(--green); color:white; border:none; border-radius:9px; cursor:pointer; font-weight:900; font-size:.82rem; display:none; transition:background .2s; }
        .btn-m-save:hover  { background:#1e8449; }
        .btn-m-save:disabled { background:#aaa; cursor:not-allowed; }
        .btn-m-close { padding:12px 16px; background:#ecf0f1; color:#666; border:none; border-radius:9px; cursor:pointer; font-weight:700; font-size:.82rem; }

        /* íŒŒì‹± input ìŠ¤íƒ€ì¼ */
        .pv-input { width:100%; border:1.5px solid #e2e8f0; border-radius:7px; padding:6px 9px; font-size:.82rem; font-weight:700; color:#1a1a2e; background:white; box-sizing:border-box; transition:border-color .2s; }
        .pv-input:focus { outline:none; border-color:var(--accent); }
        .pv-input.hi { color:var(--accent); }
        .pv-input.er { color:var(--red); }
        select.pv-input { cursor:pointer; }
        .pv-ta { height:70px; resize:vertical; font-weight:400; font-size:.78rem; line-height:1.6; }

        /* í† ìŠ¤íŠ¸ */
        #toast { position:fixed; bottom:26px; right:26px; padding:12px 18px; border-radius:10px; font-size:.79rem; font-weight:700; z-index:19999; opacity:0; transform:translateY(14px); transition:all .26s; pointer-events:none; max-width:280px; color:white; }
        #toast.show { opacity:1; transform:translateY(0); }
        #toast.ok  { background:#1e8449; }
        #toast.er  { background:#c0392b; }
        #toast.inf { background:var(--primary); }
    </style>
</head>
<body>

<!-- ìƒë‹¨ ë°” -->
<div class="top-bar">
    <div>
        <div class="brand">CREATED BY JS KIM OF LAM</div>
        <div class="sub">Plant Status Archive</div>
    </div>
    <button class="btn-input-top" onclick="openModal()">
        <span>ğŸ“‹</span> ì •ë³´ ì œë³´
    </button>
</div>

<!-- ICIS ì…ë ¥ ëª¨ë‹¬ -->
<div id="overlay">
    <div id="modal">
        <div class="mhead">
            <h3>ğŸ“‹ ICIS Plant Status ì…ë ¥</h3>
            <span class="ver">Apps Script</span>
        </div>

        <!-- ë¹„ë°€ë²ˆí˜¸ ì¸ì¦ í™”ë©´ -->
        <div id="auth-screen" style="padding:40px 28px;text-align:center;">
            <div style="font-size:2rem;margin-bottom:12px;">ğŸ”’</div>
            <div style="font-size:.95rem;font-weight:900;color:var(--primary);margin-bottom:6px;">ê´€ë¦¬ì ì¸ì¦</div>
            <div style="font-size:.75rem;color:#aaa;margin-bottom:22px;">ì…ë ¥ ê¶Œí•œì´ ìˆëŠ” ê´€ë¦¬ìë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
            <input type="password" id="pw-input"
                placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥"
                style="width:100%;padding:13px 16px;border:2px solid #e2e8f0;border-radius:10px;font-size:.9rem;text-align:center;box-sizing:border-box;transition:border-color .2s;outline:none;"
                onkeydown="if(event.key==='Enter') verifyPw()"
                onfocus="this.style.borderColor='var(--accent)'"
                onblur="this.style.borderColor='#e2e8f0'">
            <div id="pw-err" style="color:var(--red);font-size:.75rem;margin-top:8px;display:none;">âŒ ë¹„ë°€ë²ˆí˜¸ê°€ ë§ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
            <button onclick="verifyPw()"
                style="width:100%;margin-top:14px;padding:13px;background:var(--primary);color:white;border:none;border-radius:10px;font-weight:900;font-size:.88rem;cursor:pointer;">
                í™•ì¸
            </button>
        </div>

        <div class="mbody" id="input-screen" style="display:none;">
            <span class="mlabel">ICIS ê¸°ì‚¬ í…ìŠ¤íŠ¸ ë¶™ì—¬ë„£ê¸°</span>
            <textarea id="icis-input" placeholder="ICIS plant status ê¸°ì‚¬ ì „ì²´ë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.

ì˜ˆì‹œ:
Name: Asahi Kasei Mitsubishi Chemical
Location: Mizushima, Japan
Product: Ethylene, propylene
Capacity (tonnes/year): 567,000 (ethylene), 300,000 (propylene)
Event start: 5 February
Event finish: Around 16 February
Reason: Maintenance
Comments: The producer shut in early February to resolve
some technical issues that occurred earlier in January."></textarea>

            <div id="pv-wrap">
                <div class="pv-head">
                    <span>ğŸ“Š íŒŒì‹± ê²°ê³¼</span>
                    <span id="pbadge" class="pbadge pb-ok">âœ… íŒŒì‹± ì™„ë£Œ</span>
                </div>
                <div class="pg" id="pg"></div>
            </div>
        </div>
        <div class="mfoot">
            <button class="btn-m-parse" id="btn-parse" onclick="doParse()">ğŸ” íŒŒì‹±</button>
            <button class="btn-m-save" id="btn-save" onclick="doSave()">ğŸ’¾ êµ¬ê¸€ì‹œíŠ¸ ì €ì¥</button>
            <button class="btn-m-close" onclick="closeModal()">ë‹«ê¸°</button>
        </div>
    </div>
</div>

<!-- ì¡°íšŒ ì˜ì—­ -->
<div class="page-wrap">
    <div class="filter-card">
        <div class="row g-2 align-items-center">
            <div class="col-md-4">
                <select id="pSelect" onchange="updateComp()">
                    <option value="">í’ˆëª©(Product) ì„ íƒ</option>
                </select>
            </div>
            <div class="col-md-3">
                <select id="cSelect" onchange="render()" disabled>
                    <option value="">ì „ì²´ ì—…ì²´ ë³´ê¸°</option>
                </select>
            </div>
            <div class="col-md-3">
                <select id="rSelect" onchange="render()" disabled>
                    <option value="">ì „ì²´ ì‚¬ìœ  ë³´ê¸°</option>
                </select>
            </div>
            <div class="col-md-2">
                <button class="btn-refresh" onclick="init()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            </div>
        </div>
    </div>

    <div id="loading">
        <div class="spinner"></div>
        ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
    </div>
    <div class="result-count" id="rc" style="display:none"></div>
    <div id="displayArea">
        <div id="empty-msg">í’ˆëª©ê³¼ ì—…ì²´ë¥¼ ì„ íƒí•˜ë©´ ìƒì„¸ ì •ë³´ê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</div>
    </div>
</div>

<div id="toast"></div>

<script>
    // â˜… Apps Script ì›¹ì•± ë°°í¬ URL (doGet + doPost ëª¨ë‘ ì´ URL)
    const GAS_URL   = "https://script.google.com/macros/s/AKfycbwfdkq0PuT4FQQ6eI774N_s2hww5WmLaNG552nq_yYvZDzGbE6olQ9M1A1tDSCx5H9-7g/exec";
    const ADMIN_PW  = "0111";

    let db = [], parsed = null, authed = false, currentRows = [];

    // â”€â”€ ì¡°íšŒ â”€â”€
    async function init() {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('displayArea').innerHTML = '';
        document.getElementById('rc').style.display = 'none';
        try {
            const res  = await fetch(GAS_URL + '?t=' + Date.now());
            const data = await res.json();
            db = data.slice(1); // í—¤ë” ì œì™¸

            const prods = [...new Set(db.map(x => x[3]))].filter(x => x && x !== '-');
            const ps = document.getElementById('pSelect');
            ps.innerHTML = '<option value="">í’ˆëª©(Product) ì„ íƒ</option>';
            prods.forEach(p => ps.innerHTML += `<option value="${p}">${p}</option>`);
        } catch(e) {
            document.getElementById('displayArea').innerHTML =
                `<div style="text-align:center;padding:50px;color:#e74c3c;font-size:.85rem">âŒ ë¡œë“œ ì‹¤íŒ¨: ${e.message}</div>`;
        } finally {
            document.getElementById('loading').style.display = 'none';
            if (!document.getElementById('displayArea').innerHTML.trim())
                document.getElementById('displayArea').innerHTML =
                    '<div id="empty-msg" style="text-align:center;padding:55px;color:#ccc;font-size:.9rem">í’ˆëª©ê³¼ ì—…ì²´ë¥¼ ì„ íƒí•˜ë©´ ìƒì„¸ ì •ë³´ê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</div>';
        }
    }

    function updateComp() {
        const p = document.getElementById('pSelect').value;
        const cs = document.getElementById('cSelect');
        const rs = document.getElementById('rSelect');
        cs.innerHTML = '<option value="">ì „ì²´ ì—…ì²´ ë³´ê¸°</option>';
        rs.innerHTML = '<option value="">ì „ì²´ ì‚¬ìœ  ë³´ê¸°</option>';
        document.getElementById('rc').style.display = 'none';
        if (!p) {
            cs.disabled = true; rs.disabled = true;
            document.getElementById('displayArea').innerHTML =
                '<div style="text-align:center;padding:55px;color:#ccc;font-size:.9rem">í’ˆëª©ì„ ì„ íƒí•˜ì„¸ìš”.</div>';
            return;
        }
        const filtered = db.filter(x => x[3] === p);
        // ì—…ì²´ ëª©ë¡
        const comps = [...new Set(filtered.map(x => x[1]))].sort();
        comps.forEach(c => cs.innerHTML += `<option value="${c}">${c}</option>`);
        cs.disabled = false;
        // ì‚¬ìœ  ëª©ë¡ (Hì—´=index 7)
        const reasons = [...new Set(filtered.map(x => x[7]).filter(x => x && x !== '-'))].sort();
        reasons.forEach(r => rs.innerHTML += `<option value="${r}">${r}</option>`);
        rs.disabled = false;
        // í’ˆëª© ì„ íƒë§Œ í•´ë„ ì „ì²´ ì¹´ë“œ ë°”ë¡œ í‘œì‹œ
        renderCards(p, '', '');
    }

    function sc(s) {
        if (!s) return 'mn';
        const l = s.toLowerCase();
        return l.includes('shutdown') ? 'sd' : l.includes('run cut') ? 'rc' : l.includes('restart') ? 'rs' : 'mn';
    }

    function render() {
        const p = document.getElementById('pSelect').value;
        const c = document.getElementById('cSelect').value;
        const r = document.getElementById('rSelect').value;
        renderCards(p, c, r);
    }

    function renderCards(p, c, r) {
        if (!p) return;
        const rows = db.filter(x =>
            x[3] === p &&
            (!c || x[1] === c) &&
            (!r || x[7] === r)
        ).sort((a, b) => new Date(b[0]) - new Date(a[0]));
        const area = document.getElementById('displayArea');
        const rcEl = document.getElementById('rc');

        if (!rows.length) {
            area.innerHTML = '<div style="text-align:center;padding:50px;color:#ccc">ê²°ê³¼ ì—†ìŒ</div>';
            rcEl.style.display = 'none'; return;
        }
        rcEl.style.display = 'block';
        const filterDesc = [c, r].filter(Boolean).join(' / ');
        rcEl.innerHTML = filterDesc
            ? `<span>${filterDesc}</span> â€” ì´ <span>${rows.length}ê±´</span>`
            : `<span>${p}</span> ì „ì²´ â€” ì´ <span>${rows.length}ê±´</span> (ê¸°ì‚¬ ìµœì‹ ìˆœ)`;

        currentRows = rows; // ìˆ˜ì • ëª¨ë‹¬ì—ì„œ ì°¸ì¡°ìš©
        area.innerHTML = rows.map((item, idx) => {
            const cls     = sc(item[5] || '');
            const date    = item[0] ? new Date(item[0]).toLocaleString('ko-KR', {year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}) : '-';
            const capa    = item[4] && item[4] !== '-' ? item[4] : null;
            const comment = item[8] && item[8] !== '-' ? item[8] : null;
            return `
            <div class="info-card card-${cls}" id="card-${idx}">
                <div class="card-top">
                    <div>
                        <div class="card-company">${item[1]||'-'}</div>
                        <div class="card-date">ê¸°ì‚¬ì¼: ${date}</div>
                    </div>
                    <div style="display:flex;align-items:center;gap:8px;flex-shrink:0">
                        <span class="sbadge sb-${cls}">${item[5]||'-'}</span>
                    </div>
                </div>
                <div class="row-item"><div class="rl">ì§€ì—­</div><div class="rv">${item[2]||'-'}</div></div>
                <div class="row-item"><div class="rl">í’ˆëª©</div><div class="rv">${item[3]||'-'}</div></div>
                <div class="row-item"><div class="rl">ì¼€íŒŒ(Capacity)</div><div class="rv ${capa?'capa':'miss'}">${capa||'ë¯¸ì…ë ¥'}</div></div>
                <div class="row-item"><div class="rl">ì´ë²¤íŠ¸ ê¸°ê°„</div><div class="rv">${item[6]||'-'}</div></div>
                <div class="row-item"><div class="rl">ì‚¬ìœ </div><div class="rv">${item[7]||'-'}</div></div>
                <div class="row-item" style="flex-direction:column;border-bottom:none">
                    <div class="rl" style="margin-bottom:6px">ì½”ë©˜íŠ¸</div>
                    <div class="cmt-box">${comment || '<span style="color:#ccc">ì—†ìŒ</span>'}</div>
                </div>
            </div>`;
        }).join('');
    }

    // â”€â”€ ICIS ì…ë ¥ ëª¨ë‹¬ â”€â”€
    function openModal() {
        parsed = null;
        document.getElementById('icis-input').value = '';
        document.getElementById('pv-wrap').style.display = 'none';
        document.getElementById('btn-save').style.display = 'none';
        // ì¸ì¦ ìƒíƒœ ì´ˆê¸°í™”
        if (!authed) {
            document.getElementById('auth-screen').style.display = 'block';
            document.getElementById('input-screen').style.display = 'none';
            document.getElementById('pw-input').value = '';
            document.getElementById('pw-err').style.display = 'none';
            document.getElementById('btn-parse').style.display = 'none';
        } else {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('input-screen').style.display = 'block';
            document.getElementById('btn-parse').style.display = 'block';
        }
        document.getElementById('overlay').classList.add('open');
        if (!authed) setTimeout(() => document.getElementById('pw-input').focus(), 100);
    }

    function verifyPw() {
        const val = document.getElementById('pw-input').value;
        if (val === ADMIN_PW) {
            authed = true;
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('input-screen').style.display = 'block';
            document.getElementById('btn-parse').style.display = 'block';
            setTimeout(() => document.getElementById('icis-input').focus(), 100);
        } else {
            document.getElementById('pw-err').style.display = 'block';
            document.getElementById('pw-input').value = '';
            document.getElementById('pw-input').focus();
        }
    }

    function closeModal() { document.getElementById('overlay').classList.remove('open'); }

    // ì¤„ëê¹Œì§€ë§Œ ì¶”ì¶œ â€” ë‹¤ìŒ ì¤„ ë”¸ë ¤ì˜¤ëŠ” ë¬¸ì œ ì™„ì „ ì°¨ë‹¨
    function xf(text, key) {
        const esc = key.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const m = text.match(new RegExp(esc + '[^:\\r\\n]*:\\s*([^\\r\\n]+)', 'i'));
        return m ? m[1].trim() : '-';
    }

    function pillHtml(s) {
        const map = {Shutdown:'sp-sd','Run Cut':'sp-rc',Maintenance:'sp-mn',Restart:'sp-rs'};
        return `<span class="spill ${map[s]||'sp-mn'}">${s}</span>`;
    }

    function doParse() {
        const raw = document.getElementById('icis-input').value.trim();
        if (!raw) { toast('í…ìŠ¤íŠ¸ë¥¼ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”.','er'); return; }

        const company  = xf(raw,'Name');
        const location = xf(raw,'Location');
        const product  = xf(raw,'Product');
        const capa     = xf(raw,'Capacity');
        const start    = xf(raw,'Event start');
        const finish   = xf(raw,'Event finish');
        const reason   = xf(raw,'Reason');
        const comment  = xf(raw,'Comments');
        const lo = raw.toLowerCase();
        const status = lo.includes('shutdown')?'Shutdown':lo.includes('run cut')?'Run Cut':lo.includes('restart')?'Restart':'Maintenance';
        const period = (start!=='-'||finish!=='-')?`${start} ~ ${finish}`:'-';
        const capaOk = capa !== '-';
        const allOk  = [company,location,product,capa].every(v=>v!=='-');

        // ê¸°ì‚¬ ë°œí–‰ ë‚ ì§œ ì¶”ì¶œ: "16-Feb-26 11:10" ë˜ëŠ” "14-Feb-26 00:48" í˜•ì‹
        const dateMatch = raw.match(/(\d{1,2}-(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)-\d{2})\s+(\d{2}:\d{2})/i);
        const articleDate = dateMatch ? `${dateMatch[1]} ${dateMatch[2]}` : '-';

        parsed = {company,location,product,capa,status,period,start,finish,reason,comment,articleDate,raw};

        document.getElementById('pg').innerHTML = `
            <div class="pf"><div class="pl">ì—…ì²´ëª… *</div><input class="pv-input hi" id="ed-company"  value="${company}"></div>
            <div class="pf"><div class="pl">ì§€ì—­ *</div><input class="pv-input"    id="ed-location" value="${location}"></div>
            <div class="pf"><div class="pl">í’ˆëª© *</div><input class="pv-input"    id="ed-product"  value="${product}"></div>
            <div class="pf ${capaOk?'capa-ok':'capa-miss'}">
                <div class="pl">ì¼€íŒŒ ${capaOk?'âœ…':'âš ï¸ ì§ì ‘ ì…ë ¥'}</div>
                <input class="pv-input ${capaOk?'hi':'er'}" id="ed-capa" value="${capa}">
            </div>
            <div class="pf">
                <div class="pl">ìƒíƒœ</div>
                <select class="pv-input" id="ed-status">
                    <option ${status==='Shutdown'?'selected':''}>Shutdown</option>
                    <option ${status==='Run Cut'?'selected':''}>Run Cut</option>
                    <option ${status==='Maintenance'?'selected':''}>Maintenance</option>
                    <option ${status==='Restart'?'selected':''}>Restart</option>
                </select>
            </div>
            <div class="pf"><div class="pl">ì‚¬ìœ </div><input class="pv-input" id="ed-reason" value="${reason}"></div>
            <div class="pf"><div class="pl">Event start</div><input class="pv-input" id="ed-start"  value="${start}"></div>
            <div class="pf"><div class="pl">Event finish</div><input class="pv-input" id="ed-finish" value="${finish}"></div>
            <div class="pf"><div class="pl">ê¸°ì‚¬ ë°œí–‰ì¼ ğŸ“°</div><input class="pv-input hi" id="ed-articledate" value="${articleDate}"></div>
            <div class="pf full"><div class="pl">ì½”ë©˜íŠ¸</div><textarea class="pv-input pv-ta" id="ed-comment">${comment!=='-'?comment:''}</textarea></div>`;

        const b = document.getElementById('pbadge');
        b.textContent = capaOk?'âœ… íŒŒì‹± ì™„ë£Œ â€” ìˆ˜ì • í›„ ì €ì¥':'âš ï¸ ì¼€íŒŒ ë¯¸ì¸ì‹ â€” ì§ì ‘ ì…ë ¥ í›„ ì €ì¥';
        b.className   = `pbadge ${capaOk?'pb-ok':'pb-warn'}`;
        document.getElementById('pv-wrap').style.display = 'block';
        document.getElementById('btn-save').style.display = 'block';
        toast(allOk?'íŒŒì‹± ì™„ë£Œ! ë‚´ìš© í™•ì¸ ë° ìˆ˜ì • í›„ ì €ì¥í•˜ì„¸ìš”.':'âš ï¸ ì¼ë¶€ í•„ë“œ ë¯¸ì¸ì‹ â€” ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”.', allOk?'ok':'inf');
    }

    async function doSave() {
        if (!parsed) { toast('ë¨¼ì € íŒŒì‹±í•˜ì„¸ìš”.','er'); return; }

        // ìˆ˜ì •ëœ input ê°’ ì½ê¸°
        const company     = document.getElementById('ed-company').value.trim();
        const location    = document.getElementById('ed-location').value.trim();
        const product     = document.getElementById('ed-product').value.trim();
        const capa        = document.getElementById('ed-capa').value.trim();
        const status      = document.getElementById('ed-status').value;
        const reason      = document.getElementById('ed-reason').value.trim();
        const start       = document.getElementById('ed-start').value.trim();
        const finish      = document.getElementById('ed-finish').value.trim();
        const articleDate = document.getElementById('ed-articledate').value.trim();
        const comment     = document.getElementById('ed-comment').value.trim();
        const period      = (start&&start!=='-'||finish&&finish!=='-') ? `${start} ~ ${finish}` : '-';

        if (!company) { toast('ì—…ì²´ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.','er'); return; }

        // â”€â”€ ì¤‘ë³µ ì²´í¬: ì—…ì²´ëª… + ê¸°ì‚¬ë°œí–‰ì¼ ì¡°í•©ì´ ì´ë¯¸ ìˆìœ¼ë©´ ì°¨ë‹¨ â”€â”€
        const isDup = db.some(row => {
            const rowCompany = (row[1] || '').trim().toLowerCase();
            const rowDate    = row[0] ? String(row[0]).trim() : '';
            return rowCompany === company.toLowerCase() && rowDate.includes(articleDate.split(' ')[0]);
        });
        if (isDup) {
            toast('âš ï¸ ì´ë¯¸ ì €ì¥ëœ ê¸°ì‚¬ì…ë‹ˆë‹¤ â€” ' + company + ' / ' + articleDate, 'inf', 5000);
            return;
        }

        const btn = document.getElementById('btn-save');
        btn.textContent='ì €ì¥ ì¤‘...'; btn.disabled=true;
        try {
            const res = await fetch(GAS_URL, {
                method:'POST',
                headers:{'Content-Type':'text/plain'},
                body: JSON.stringify({
                    action:'saveIcis',
                    data:{
                        date:     articleDate,
                        company, location, product, capa,
                        status,  period,   reason,  comment,
                        raw:      parsed.raw,
                        articleDate
                    }
                })
            });
            const r = await res.json();
            if (r.success) {
                toast('âœ… ì €ì¥ ì™„ë£Œ! '+parsed.company,'ok',4000);
                closeModal();
                const curP = document.getElementById('pSelect').value;
                const curC = document.getElementById('cSelect').value;
                const curR = document.getElementById('rSelect').value;
                await init();
                if (curP) {
                    document.getElementById('pSelect').value = curP;
                    updateComp();
                    if (curC) document.getElementById('cSelect').value = curC;
                    if (curR) document.getElementById('rSelect').value = curR;
                    renderCards(curP, curC, curR);
                }
            } else toast('ì €ì¥ ì‹¤íŒ¨: '+(r.message||'ì˜¤ë¥˜'),'er');
        } catch(e) {
            toast('âŒ ì˜¤ë¥˜: '+e.message,'er');
        } finally {
            btn.textContent='ğŸ’¾ êµ¬ê¸€ì‹œíŠ¸ ì €ì¥'; btn.disabled=false;
        }
    }

    function toast(msg,type='inf',ms=3400){
        const t=document.getElementById('toast');
        t.textContent=msg; t.className=`show ${type}`;
        clearTimeout(t._t); t._t=setTimeout(()=>t.className='',ms);
    }

    // ESC / ë°°ê²½ í´ë¦­ìœ¼ë¡œ ë‹«ê¸°
    document.addEventListener('keydown', e => { if(e.key==='Escape') closeModal(); });
    document.getElementById('overlay').addEventListener('click', e => { if(e.target===document.getElementById('overlay')) closeModal(); });

    init();
</script>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     Apps Script ì½”ë“œ (ì°¸ê³ ìš© â€” ë³„ë„ ë¶™ì—¬ë„£ê¸°)
     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var SPREADSHEET_ID = '1EA2496AQPJVmM6FwiJeEhgg1Zo925lLWupJEojWCz7c';

function doGet() {
  var data = SpreadsheetApp.openById(SPREADSHEET_ID).getActiveSheet().getDataRange().getValues();
  return ContentService.createTextOutput(JSON.stringify(data)).setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  try {
    var body = JSON.parse(e.postData.contents);
    if (body.action === 'saveIcis') {
      var d = body.data;
      SpreadsheetApp.openById(SPREADSHEET_ID).getActiveSheet().appendRow([
        new Date(d.date), d.company, d.location, d.product,  // Aì—´ = ê¸°ì‚¬ ë°œí–‰ì¼
        d.capa, d.status, d.period, d.reason, d.comment, '', d.raw
      ]);
      return ContentService.createTextOutput(JSON.stringify({success:true,message:d.company+' ì €ì¥ ì™„ë£Œ'})).setMimeType(ContentService.MimeType.JSON);
    }

    if (body.action === 'editIcis') {
      var key  = body.rowKey;  // { date, company }
      var d    = body.data;
      var sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getActiveSheet();
      var rows  = sheet.getDataRange().getValues();
      for (var i = 1; i < rows.length; i++) {
        var rowDate    = rows[i][0] ? String(rows[i][0]).trim() : '';
        var rowCompany = rows[i][1] ? rows[i][1].toString().trim().toLowerCase() : '';
        if (rowCompany === key.company.trim().toLowerCase() &&
            rowDate.includes(key.date.substring(0, 10))) {
          var r = i + 1; // 1-indexed
          sheet.getRange(r, 1).setValue(d.date);
          sheet.getRange(r, 2).setValue(d.company);
          sheet.getRange(r, 3).setValue(d.location);
          sheet.getRange(r, 4).setValue(d.product);
          sheet.getRange(r, 5).setValue(d.capa);
          sheet.getRange(r, 6).setValue(d.status);
          sheet.getRange(r, 7).setValue(d.period);
          sheet.getRange(r, 8).setValue(d.reason);
          sheet.getRange(r, 9).setValue(d.comment);
          return ContentService.createTextOutput(JSON.stringify({success:true,message:'ìˆ˜ì • ì™„ë£Œ'})).setMimeType(ContentService.MimeType.JSON);
        }
      }
      return ContentService.createTextOutput(JSON.stringify({success:false,message:'í•´ë‹¹ í–‰ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'})).setMimeType(ContentService.MimeType.JSON);
    }
    return ContentService.createTextOutput(JSON.stringify({success:false,message:'unknown action'})).setMimeType(ContentService.MimeType.JSON);
  } catch(err) {
    return ContentService.createTextOutput(JSON.stringify({success:false,message:err.toString()})).setMimeType(ContentService.MimeType.JSON);
  }
}
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
</body>
</html>
