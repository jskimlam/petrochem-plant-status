<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>PLANT ARCHIVE | JS KIM</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --primary:#0A2647; --accent:#1597BB; --green:#27ae60; --red:#E74C3C; --orange:#D35400; }
        body { background:#f0f2f5; font-family:'Pretendard','Segoe UI',sans-serif; min-height:100vh; margin:0; }

        /* â”€â”€ ìƒë‹¨ ë°” â”€â”€ */
        .top-bar { background:var(--primary); padding:16px 28px; display:flex; align-items:center; justify-content:space-between; box-shadow:0 3px 15px rgba(0,0,0,.25); }
        .top-bar .brand { font-size:.95rem; font-weight:900; color:#FFD700; letter-spacing:.05em; }
        .top-bar .sub   { font-size:.65rem; color:rgba(255,255,255,.5); margin-top:2px; }
        .btn-input-top  { background:var(--accent); color:white; border:none; padding:9px 18px; border-radius:20px; font-weight:900; font-size:.78rem; cursor:pointer; transition:background .2s; display:flex; align-items:center; gap:7px; }
        .btn-input-top:hover { background:#0d86a8; }

        /* â”€â”€ í˜ì´ì§€ â”€â”€ */
        .page-wrap { max-width:820px; margin:32px auto; padding:0 20px 80px; }

        /* â”€â”€ í•„í„° ì¹´ë“œ â”€â”€ */
        .filter-card { background:white; border-radius:14px; padding:20px 22px; box-shadow:0 6px 22px rgba(0,0,0,.07); margin-bottom:20px; }
        .filter-card select { border:1.5px solid #e2e8f0; border-radius:9px; padding:10px 14px; font-size:.84rem; color:#333; font-weight:600; width:100%; transition:border-color .2s; }
        .filter-card select:focus { outline:none; border-color:var(--accent); box-shadow:none; }
        .filter-card select:disabled { background:#f5f7fa; color:#bbb; }
        .btn-refresh { background:var(--primary); color:white; border:none; border-radius:9px; padding:10px 16px; font-weight:700; font-size:.78rem; cursor:pointer; white-space:nowrap; width:100%; transition:opacity .2s; }
        .btn-refresh:hover { opacity:.85; }

        /* â”€â”€ ë¡œë”© â”€â”€ */
        #loading { text-align:center; padding:55px; display:none; color:#aaa; }
        .spinner { width:30px; height:30px; border:3px solid #e2e8f0; border-top-color:var(--accent); border-radius:50%; animation:spin .7s linear infinite; margin:0 auto 12px; }
        @keyframes spin { to { transform:rotate(360deg) } }

        /* â”€â”€ ê²°ê³¼ ì¹´ìš´íŠ¸ â”€â”€ */
        .result-count { font-size:.75rem; color:#999; margin-bottom:12px; font-weight:600; }
        .result-count span { color:var(--accent); font-weight:900; }

        /* â”€â”€ ì•„ì¹´ì´ë¸Œ ì¹´ë“œ â”€â”€ */
        .info-card { background:white; border-radius:14px; padding:26px 28px; box-shadow:0 6px 22px rgba(0,0,0,.07); margin-bottom:16px; border-left:5px solid #dee2e6; }
        .card-sd { border-left-color:var(--red); }
        .card-rc { border-left-color:var(--orange); }
        .card-mn { border-left-color:var(--green); }
        .card-rs { border-left-color:var(--accent); }

        .card-top { display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:16px; }
        .card-company { font-size:1.05rem; font-weight:900; color:var(--primary); }
        .card-date    { font-size:.65rem; color:#bbb; margin-top:3px; }
        .sbadge { display:inline-block; padding:5px 13px; border-radius:20px; font-weight:800; font-size:.75rem; flex-shrink:0; }
        .sb-sd { background:#ffe3e3; color:#c0392b; }
        .sb-rc { background:#fff4e6; color:#d35400; }
        .sb-mn { background:#e8f8f0; color:#1e8449; }
        .sb-rs { background:#e8f0fe; color:#2471a3; }

        /* â”€â”€ ìˆ˜ì • ë²„íŠ¼ (ì¹´ë“œ ë‚´) â”€â”€ */
        .btn-edit-card { background:transparent; border:1.5px solid #d1d5db; color:#6b7280; border-radius:8px; padding:4px 11px; font-size:.68rem; font-weight:700; cursor:pointer; transition:all .18s; flex-shrink:0; }
        .btn-edit-card:hover { background:var(--primary); color:white; border-color:var(--primary); }

        .row-item { display:flex; border-bottom:1px solid #f5f5f5; padding:9px 0; align-items:flex-start; }
        .row-item:last-child { border-bottom:none; }
        .rl { width:130px; flex-shrink:0; font-size:.75rem; color:#aaa; font-weight:700; padding-top:2px; }
        .rv { font-size:.88rem; color:#2d3436; font-weight:500; word-break:break-word; }
        .rv.capa { color:var(--accent); font-weight:900; font-size:.98rem; }
        .rv.miss { color:#ccc; font-style:italic; font-size:.8rem; }
        .cmt-box { background:#f8fafc; border-radius:8px; padding:11px 13px; border-left:4px solid #dee2e6; font-size:.78rem; color:#666; line-height:1.65; width:100%; margin-top:4px; }

        /* â”€â”€ ë¹ˆ ìƒíƒœ â”€â”€ */
        #empty-msg { text-align:center; padding:55px; color:#ccc; font-size:.9rem; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           â”€â”€ ê³µí†µ ëª¨ë‹¬ ê¸°ë°˜ ìŠ¤íƒ€ì¼ â”€â”€
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .m-overlay { position:fixed; inset:0; background:rgba(5,20,50,.88); z-index:9000; display:none; align-items:center; justify-content:center; backdrop-filter:blur(5px); }
        .m-overlay.open { display:flex; }
        .m-box { width:580px; max-height:92vh; background:white; border-radius:18px; box-shadow:0 24px 70px rgba(0,0,0,.5); display:flex; flex-direction:column; overflow:hidden; animation:mIn .22s ease; }
        @keyframes mIn { from{opacity:0;transform:translateY(18px) scale(.97)} to{opacity:1;transform:none} }

        .mhead { background:var(--primary); color:white; padding:18px 22px; display:flex; justify-content:space-between; align-items:center; flex-shrink:0; }
        .mhead h3 { margin:0; font-size:.98rem; font-weight:900; }
        .mhead .ver { background:var(--accent); font-size:.6rem; padding:3px 9px; border-radius:9px; font-weight:900; }
        /* Edit ëª¨ë‹¬ í—¤ë”ëŠ” ì£¼í™© ê°•ì¡° */
        .mhead.edit-head { background:#b7450a; }
        .mhead.edit-head .ver { background:#e67e22; }

        .mbody { padding:20px 22px; overflow-y:auto; flex:1; }
        .mlabel { font-size:.65rem; font-weight:900; color:#aaa; text-transform:uppercase; letter-spacing:.1em; display:block; margin-bottom:7px; }
        #icis-input { width:100%; height:200px; border:2px solid #e2e8f0; border-radius:10px; padding:13px; font-size:.78rem; font-family:'Segoe UI',monospace; resize:vertical; line-height:1.72; color:#333; transition:border-color .2s; box-sizing:border-box; }
        #icis-input:focus { outline:none; border-color:var(--accent); }
        #icis-input::placeholder { color:#c5c9d0; line-height:1.9; }

        /* â”€â”€ íŒŒì‹± ê²°ê³¼ ê·¸ë¦¬ë“œ â”€â”€ */
        #pv-wrap  { display:none; margin-top:16px; border:1.5px solid #e2e8f0; border-radius:12px; overflow:hidden; }
        /* Edit ëª¨ë‹¬ ë‚´ í•„ë“œ ê·¸ë¦¬ë“œ â€” í•­ìƒ í‘œì‹œ */
        #edit-grid { border:1.5px solid #e2e8f0; border-radius:12px; overflow:hidden; }
        .pv-head { background:#f0f5f9; padding:10px 14px; font-size:.67rem; font-weight:900; color:var(--primary); border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center; }
        .pbadge { font-size:.63rem; padding:3px 9px; border-radius:7px; font-weight:900; }
        .pb-ok   { background:#d4efdf; color:#1e8449; }
        .pb-warn { background:#fdebd0; color:#d35400; }
        .pg { display:grid; grid-template-columns:1fr 1fr; }
        .pf { padding:10px 14px; border-bottom:1px solid #f2f2f2; border-right:1px solid #f2f2f2; }
        .pf:nth-child(2n) { border-right:none; }
        .pf.full { grid-column:1/-1; border-right:none; }
        .pf.capa-ok   { background:linear-gradient(135deg,#eaf5fb,#d4edf5); border:1.5px solid var(--accent); }
        .pf.capa-miss { background:#fff7f7; border:1.5px solid #f5c6c6; }
        .pl { font-size:.56rem; color:#bbb; text-transform:uppercase; font-weight:800; letter-spacing:.08em; }
        .pv { font-size:.84rem; font-weight:700; color:#1a1a2e; margin-top:3px; word-break:break-word; }
        .pv.hi { color:var(--accent); }
        .pv.er { color:var(--red); }

        /* â”€â”€ ëª¨ë‹¬ í•˜ë‹¨ ë²„íŠ¼ ë°” â”€â”€ */
        .mfoot { padding:14px 22px; border-top:1px solid #eee; display:flex; gap:9px; flex-shrink:0; background:#fafafa; }
        .btn-m-parse  { flex:1; padding:12px; background:var(--accent); color:white; border:none; border-radius:9px; cursor:pointer; font-weight:900; font-size:.82rem; transition:background .2s; }
        .btn-m-parse:hover  { background:#0d86a8; }
        .btn-m-save   { flex:2; padding:12px; background:var(--green); color:white; border:none; border-radius:9px; cursor:pointer; font-weight:900; font-size:.82rem; display:none; transition:background .2s; }
        .btn-m-save:hover   { background:#1e8449; }
        .btn-m-save:disabled { background:#aaa; cursor:not-allowed; }
        .btn-m-update { flex:2; padding:12px; background:#d35400; color:white; border:none; border-radius:9px; cursor:pointer; font-weight:900; font-size:.82rem; transition:background .2s; }
        .btn-m-update:hover  { background:#b7450a; }
        .btn-m-update:disabled { background:#aaa; cursor:not-allowed; }
        .btn-m-close  { padding:12px 16px; background:#ecf0f1; color:#666; border:none; border-radius:9px; cursor:pointer; font-weight:700; font-size:.82rem; }

        /* â”€â”€ input/select/textarea ê³µí†µ (íŒŒì‹± ê²°ê³¼ + Edit í¼) â”€â”€ */
        .pv-input { width:100%; border:1.5px solid #e2e8f0; border-radius:7px; padding:6px 9px; font-size:.82rem; font-weight:700; color:#1a1a2e; background:white; box-sizing:border-box; transition:border-color .2s; }
        .pv-input:focus { outline:none; border-color:var(--accent); }
        .pv-input.hi { color:var(--accent); }
        .pv-input.er { color:var(--red); }
        select.pv-input { cursor:pointer; }
        .pv-ta { height:70px; resize:vertical; font-weight:400; font-size:.78rem; line-height:1.6; }

        /* â”€â”€ í† ìŠ¤íŠ¸ â”€â”€ */
        #toast { position:fixed; bottom:26px; right:26px; padding:12px 18px; border-radius:10px; font-size:.79rem; font-weight:700; z-index:19999; opacity:0; transform:translateY(14px); transition:all .26s; pointer-events:none; max-width:280px; color:white; }
        #toast.show { opacity:1; transform:translateY(0); }
        #toast.ok  { background:#1e8449; }
        #toast.er  { background:#c0392b; }
        #toast.inf { background:var(--primary); }

        /* â”€â”€ spill ë°°ì§€ (íŒŒì‹± ë¯¸ë¦¬ë³´ê¸°) â”€â”€ */
        .spill { display:inline-block; padding:3px 10px; border-radius:14px; font-size:.69rem; font-weight:800; }
        .sp-sd { background:#ffe3e3; color:#c0392b; }
        .sp-rc { background:#fff4e6; color:#d35400; }
        .sp-mn { background:#e8f8f0; color:#1e8449; }
        .sp-rs { background:#e8f0fe; color:#2471a3; }
    </style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ìƒë‹¨ ë°”
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="top-bar">
    <div>
        <div class="brand">CREATED BY JS KIM OF LAM</div>
        <div class="sub">Plant Status Archive</div>
    </div>
    <div style="display:flex;align-items:center;gap:10px;">
        <!-- ì •ë³´ ì œë³´ ë²„íŠ¼ -->
        <button class="btn-input-top" onclick="openModal()">
            <span>ğŸ“‹</span> ì •ë³´ ì œë³´
        </button>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ICIS ì…ë ¥ ëª¨ë‹¬ (ì‹ ê·œ ì €ì¥)
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="overlay" class="m-overlay">
    <div id="modal" class="m-box">
        <div class="mhead">
            <h3>ğŸ“‹ ICIS Plant Status ì…ë ¥</h3>
            <span class="ver">Apps Script</span>
        </div>

        <!-- ë¹„ë°€ë²ˆí˜¸ ì¸ì¦ í™”ë©´ -->
        <div id="auth-screen" style="padding:40px 28px;text-align:center;">
            <div style="font-size:2rem;margin-bottom:12px;">ğŸ”’</div>
            <div style="font-size:.95rem;font-weight:900;color:var(--primary);margin-bottom:6px;">ê´€ë¦¬ì ì¸ì¦</div>
            <div style="font-size:.75rem;color:#aaa;margin-bottom:22px;">ì…ë ¥ ê¶Œí•œì´ ìˆëŠ” ê´€ë¦¬ìë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
            <input type="password" id="pw-input"
                placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥"
                style="width:100%;padding:13px 16px;border:2px solid #e2e8f0;border-radius:10px;font-size:.9rem;text-align:center;box-sizing:border-box;transition:border-color .2s;outline:none;"
                onkeydown="if(event.key==='Enter') verifyPw()"
                onfocus="this.style.borderColor='var(--accent)'"
                onblur="this.style.borderColor='#e2e8f0'">
            <div id="pw-err" style="color:var(--red);font-size:.75rem;margin-top:8px;display:none;">âŒ ë¹„ë°€ë²ˆí˜¸ê°€ ë§ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
            <button onclick="verifyPw()"
                style="width:100%;margin-top:14px;padding:13px;background:var(--primary);color:white;border:none;border-radius:10px;font-weight:900;font-size:.88rem;cursor:pointer;">
                í™•ì¸
            </button>
        </div>

        <!-- ì…ë ¥ í™”ë©´ (ì¸ì¦ í›„) -->
        <div class="mbody" id="input-screen" style="display:none;">
            <span class="mlabel">ICIS ê¸°ì‚¬ í…ìŠ¤íŠ¸ ë¶™ì—¬ë„£ê¸°</span>
            <textarea id="icis-input" placeholder="ICIS plant status ê¸°ì‚¬ ì „ì²´ë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.

ì˜ˆì‹œ:
Name: Asahi Kasei Mitsubishi Chemical
Location: Mizushima, Japan
Product: Ethylene, propylene
Capacity (tonnes/year): 567,000 (ethylene), 300,000 (propylene)
Event start: 5 February
Event finish: Around 16 February
Reason: Maintenance
Comments: The producer shut in early February to resolve
some technical issues that occurred earlier in January."></textarea>

            <div id="pv-wrap">
                <div class="pv-head">
                    <span>ğŸ“Š íŒŒì‹± ê²°ê³¼</span>
                    <span id="pbadge" class="pbadge pb-ok">âœ… íŒŒì‹± ì™„ë£Œ</span>
                </div>
                <div class="pg" id="pg"></div>
            </div>
        </div>

        <div class="mfoot">
            <button class="btn-m-parse" id="btn-parse" onclick="doParse()">ğŸ” íŒŒì‹±</button>
            <button class="btn-m-save"  id="btn-save"  onclick="doSave()">ğŸ’¾ êµ¬ê¸€ì‹œíŠ¸ ì €ì¥</button>
            <button class="btn-m-close" onclick="closeModal()">ë‹«ê¸°</button>
        </div>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     Edit ëª¨ë‹¬ (ê¸°ì¡´ ë°ì´í„° ìˆ˜ì •)
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="edit-overlay" class="m-overlay">
    <div id="edit-modal" class="m-box">
        <div class="mhead edit-head">
            <h3>âœï¸ ë°ì´í„° ìˆ˜ì •</h3>
            <span class="ver">Edit Mode</span>
        </div>

        <!-- Edit ëª¨ë‹¬ë„ ì¸ì¦ í•„ìš” (authed ê³µìœ ) -->
        <div id="edit-auth-screen" style="padding:40px 28px;text-align:center;">
            <div style="font-size:2rem;margin-bottom:12px;">ğŸ”’</div>
            <div style="font-size:.95rem;font-weight:900;color:var(--primary);margin-bottom:6px;">ê´€ë¦¬ì ì¸ì¦</div>
            <div style="font-size:.75rem;color:#aaa;margin-bottom:22px;">ìˆ˜ì • ê¶Œí•œì´ ìˆëŠ” ê´€ë¦¬ìë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
            <input type="password" id="edit-pw-input"
                placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥"
                style="width:100%;padding:13px 16px;border:2px solid #e2e8f0;border-radius:10px;font-size:.9rem;text-align:center;box-sizing:border-box;transition:border-color .2s;outline:none;"
                onkeydown="if(event.key==='Enter') verifyEditPw()"
                onfocus="this.style.borderColor='#d35400'"
                onblur="this.style.borderColor='#e2e8f0'">
            <div id="edit-pw-err" style="color:var(--red);font-size:.75rem;margin-top:8px;display:none;">âŒ ë¹„ë°€ë²ˆí˜¸ê°€ ë§ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
            <button onclick="verifyEditPw()"
                style="width:100%;margin-top:14px;padding:13px;background:#b7450a;color:white;border:none;border-radius:10px;font-weight:900;font-size:.88rem;cursor:pointer;">
                í™•ì¸
            </button>
        </div>

        <!-- ìˆ˜ì • í¼ -->
        <div class="mbody" id="edit-form-screen" style="display:none;">
            <!-- í˜„ì¬ ë°ì´í„° ìš”ì•½ ë°°ë„ˆ -->
            <div id="edit-banner" style="background:#fff7ed;border:1.5px solid #fed7aa;border-radius:10px;padding:11px 14px;margin-bottom:14px;font-size:.76rem;color:#92400e;line-height:1.7;">
                ìˆ˜ì • ì¤‘ì¸ ë ˆì½”ë“œ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
            </div>
            <!-- ìˆ˜ì • í•„ë“œ ê·¸ë¦¬ë“œ -->
            <div id="edit-grid">
                <div class="pv-head">
                    <span>ğŸ“ ìˆ˜ì • í•„ë“œ</span>
                    <span id="edit-badge" class="pbadge pb-ok">âœ… ë°ì´í„° ë¡œë“œ ì™„ë£Œ</span>
                </div>
                <div class="pg" id="edit-pg"></div>
            </div>
        </div>

        <div class="mfoot">
            <button class="btn-m-update" id="btn-update" onclick="doUpdate()">âœ… ìˆ˜ì • ì €ì¥</button>
            <button class="btn-m-close"  onclick="closeEditModal()">ë‹«ê¸°</button>
        </div>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ì¡°íšŒ ì˜ì—­
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page-wrap">
    <div class="filter-card">
        <div class="row g-2 align-items-center">
            <div class="col-md-4">
                <select id="pSelect" onchange="updateComp()">
                    <option value="">í’ˆëª©(Product) ì„ íƒ</option>
                </select>
            </div>
            <div class="col-md-3">
                <select id="cSelect" onchange="render()" disabled>
                    <option value="">ì „ì²´ ì—…ì²´ ë³´ê¸°</option>
                </select>
            </div>
            <div class="col-md-3">
                <select id="rSelect" onchange="render()" disabled>
                    <option value="">ì „ì²´ ì‚¬ìœ  ë³´ê¸°</option>
                </select>
            </div>
            <div class="col-md-2">
                <button class="btn-refresh" onclick="init()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            </div>
        </div>
    </div>

    <div id="loading">
        <div class="spinner"></div>
        ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
    </div>
    <div class="result-count" id="rc" style="display:none"></div>
    <div id="displayArea">
        <div id="empty-msg">í’ˆëª©ê³¼ ì—…ì²´ë¥¼ ì„ íƒí•˜ë©´ ìƒì„¸ ì •ë³´ê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</div>
    </div>
</div>

<div id="toast"></div>

<script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // â˜… ì„¤ì •ê°’ â€” GAS ë°°í¬ URL & ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const GAS_URL  = "https://script.google.com/macros/s/AKfycbwB7jbRxi9OKkL8Ggd22Ckv20_lWsWXBhypF5OKzMJ9alKizi8kqsn8bH3DaON4wbB5uw/exec";
    const ADMIN_PW = "0111";

    // â”€â”€ ì „ì—­ ìƒíƒœ â”€â”€
    let db          = [];       // ì‹œíŠ¸ì—ì„œ ë¶ˆëŸ¬ì˜¨ ì „ì²´ ë°ì´í„° (í—¤ë” ì œì™¸)
    let parsed      = null;     // í˜„ì¬ íŒŒì‹±ëœ ICIS ê¸°ì‚¬ ê°ì²´
    let authed      = false;    // ê´€ë¦¬ì ì¸ì¦ ì—¬ë¶€ (ì…ë ¥ ëª¨ë‹¬ + Edit ëª¨ë‹¬ ê³µìœ )
    let currentRows = [];       // í˜„ì¬ í™”ë©´ì— í‘œì‹œ ì¤‘ì¸ í–‰ ë°°ì—´
    let editTarget  = null;     // ìˆ˜ì • ëŒ€ìƒ í–‰ ì •ë³´ { rowData, originalDate, originalCompany }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // â”€â”€ ë°ì´í„° ì¡°íšŒ (ì´ˆê¸°í™”)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function init() {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('displayArea').innerHTML = '';
        document.getElementById('rc').style.display = 'none';
        try {
            // ìºì‹œ ë°©ì§€ë¥¼ ìœ„í•´ íƒ€ì„ìŠ¤íƒ¬í”„ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ì¶”ê°€
            const res  = await fetch(GAS_URL + '?t=' + Date.now());
            const data = await res.json();
            db = data.slice(1); // ì²« í–‰(í—¤ë”) ì œì™¸

            // í’ˆëª©(Dì—´=index 3) ëª©ë¡ ìƒì„±
            const prods = [...new Set(db.map(x => x[3]))].filter(x => x && x !== '-');
            const ps = document.getElementById('pSelect');
            ps.innerHTML = '<option value="">í’ˆëª©(Product) ì„ íƒ</option>';
            prods.forEach(p => ps.innerHTML += `<option value="${p}">${p}</option>`);
        } catch(e) {
            // ì—°ê²° ì‹¤íŒ¨ ì•ˆë‚´
            document.getElementById('displayArea').innerHTML = `
                <div style="text-align:center;padding:40px 20px;">
                    <div style="font-size:2.2rem;margin-bottom:12px;">ğŸ”Œ</div>
                    <div style="font-size:.95rem;font-weight:900;color:#c0392b;margin-bottom:6px;">Google Sheets ì—°ê²° ì‹¤íŒ¨</div>
                    <div style="font-size:.78rem;color:#aaa;margin-bottom:20px;line-height:1.7;">
                        ì¸í„°ë„· ì—°ê²° ë˜ëŠ” GAS ë°°í¬ URLì„ í™•ì¸í•˜ì„¸ìš”.<br>
                        <strong>ì˜¤ë¥˜:</strong> ${e.message}
                    </div>
                    <button onclick="init()" style="background:var(--primary);color:white;border:none;padding:12px 28px;border-radius:20px;font-weight:900;font-size:.85rem;cursor:pointer;">
                        ğŸ”„ ì¬ì‹œë„
                    </button>
                </div>`;
        } finally {
            document.getElementById('loading').style.display = 'none';
            // ì•„ë¬´ê²ƒë„ ê·¸ë ¤ì§€ì§€ ì•Šì•˜ë‹¤ë©´ ê¸°ë³¸ ì•ˆë‚´ í‘œì‹œ
            if (!document.getElementById('displayArea').innerHTML.trim())
                document.getElementById('displayArea').innerHTML =
                    '<div id="empty-msg" style="text-align:center;padding:55px;color:#ccc;font-size:.9rem">í’ˆëª©ê³¼ ì—…ì²´ë¥¼ ì„ íƒí•˜ë©´ ìƒì„¸ ì •ë³´ê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</div>';
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // â”€â”€ ì—…ì²´Â·ì‚¬ìœ  ë“œë¡­ë‹¤ìš´ ê°±ì‹  (í’ˆëª© ì„ íƒ ì‹œ)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function updateComp() {
        const p  = document.getElementById('pSelect').value;
        const cs = document.getElementById('cSelect');
        const rs = document.getElementById('rSelect');
        cs.innerHTML = '<option value="">ì „ì²´ ì—…ì²´ ë³´ê¸°</option>';
        rs.innerHTML = '<option value="">ì „ì²´ ì‚¬ìœ  ë³´ê¸°</option>';
        document.getElementById('rc').style.display = 'none';
        if (!p) {
            cs.disabled = true; rs.disabled = true;
            document.getElementById('displayArea').innerHTML =
                '<div style="text-align:center;padding:55px;color:#ccc;font-size:.9rem">í’ˆëª©ì„ ì„ íƒí•˜ì„¸ìš”.</div>';
            return;
        }
        const filtered = db.filter(x => x[3] === p);
        // Bì—´(index 1) = ì—…ì²´ëª…
        const comps = [...new Set(filtered.map(x => x[1]))].sort();
        comps.forEach(c => cs.innerHTML += `<option value="${c}">${c}</option>`);
        cs.disabled = false;
        // Hì—´(index 7) = ì‚¬ìœ 
        const reasons = [...new Set(filtered.map(x => x[7]).filter(x => x && x !== '-'))].sort();
        reasons.forEach(r => rs.innerHTML += `<option value="${r}">${r}</option>`);
        rs.disabled = false;
        // í’ˆëª© ì„ íƒë§Œ í•´ë„ ì¦‰ì‹œ ì „ì²´ ì¹´ë“œ í‘œì‹œ
        renderCards(p, '', '');
    }

    // â”€â”€ ìƒíƒœ ì½”ë“œ â†’ CSS í´ë˜ìŠ¤ ë³€í™˜ â”€â”€
    function sc(s) {
        if (!s) return 'mn';
        const l = s.toLowerCase();
        return l.includes('shutdown') ? 'sd'
             : l.includes('run cut')  ? 'rc'
             : l.includes('restart')  ? 'rs'
             : 'mn';
    }

    // â”€â”€ í•„í„° select ë³€ê²½ ì‹œ ë Œë” â”€â”€
    function render() {
        const p = document.getElementById('pSelect').value;
        const c = document.getElementById('cSelect').value;
        const r = document.getElementById('rSelect').value;
        renderCards(p, c, r);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // â”€â”€ ì¹´ë“œ ë Œë”ë§ (ì¡°íšŒ ê²°ê³¼ í‘œì‹œ)
    //    ê° ì¹´ë“œì— âœï¸ ìˆ˜ì • ë²„íŠ¼ í¬í•¨
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function renderCards(p, c, r) {
        if (!p) return;
        const rows = db.filter(x =>
            x[3] === p &&
            (!c || x[1] === c) &&
            (!r || x[7] === r)
        ).sort((a, b) => new Date(b[0]) - new Date(a[0])); // ìµœì‹ ìˆœ ì •ë ¬

        const area = document.getElementById('displayArea');
        const rcEl = document.getElementById('rc');

        if (!rows.length) {
            area.innerHTML = '<div style="text-align:center;padding:50px;color:#ccc">ê²°ê³¼ ì—†ìŒ</div>';
            rcEl.style.display = 'none';
            return;
        }

        rcEl.style.display = 'block';
        const filterDesc = [c, r].filter(Boolean).join(' / ');
        rcEl.innerHTML = filterDesc
            ? `<span>${filterDesc}</span> â€” ì´ <span>${rows.length}ê±´</span>`
            : `<span>${p}</span> ì „ì²´ â€” ì´ <span>${rows.length}ê±´</span> (ê¸°ì‚¬ ìµœì‹ ìˆœ)`;

        currentRows = rows; // Edit ëª¨ë‹¬ì—ì„œ ì°¸ì¡°

        area.innerHTML = rows.map((item, idx) => {
            const cls     = sc(item[5] || '');
            // Aì—´(index 0) = ê¸°ì‚¬ ë°œí–‰ì¼ â€” ë‚ ì§œ+ì‹œê°„ ëª¨ë‘ í‘œì‹œ
            const date    = item[0]
                ? new Date(item[0]).toLocaleString('ko-KR', {
                    year:'numeric', month:'2-digit', day:'2-digit',
                    hour:'2-digit', minute:'2-digit'
                  })
                : '-';
            const capa    = item[4] && item[4] !== '-' ? item[4] : null;
            const comment = item[8] && item[8] !== '-' ? item[8] : null;
            return `
            <div class="info-card card-${cls}" id="card-${idx}">
                <div class="card-top">
                    <div>
                        <div class="card-company">${item[1]||'-'}</div>
                        <div class="card-date">ê¸°ì‚¬ì¼: ${date}</div>
                    </div>
                    <div style="display:flex;align-items:center;gap:8px;flex-shrink:0">
                        <span class="sbadge sb-${cls}">${item[5]||'-'}</span>
                        <!-- âœï¸ ìˆ˜ì • ë²„íŠ¼ â€” í´ë¦­ ì‹œ openEditModal(idx) í˜¸ì¶œ -->
                        <button class="btn-edit-card" onclick="openEditModal(${idx})">âœï¸ ìˆ˜ì •</button>
                    </div>
                </div>
                <div class="row-item"><div class="rl">ì§€ì—­</div><div class="rv">${item[2]||'-'}</div></div>
                <div class="row-item"><div class="rl">í’ˆëª©</div><div class="rv">${item[3]||'-'}</div></div>
                <div class="row-item"><div class="rl">ì¼€íŒŒ(Capacity)</div><div class="rv ${capa?'capa':'miss'}">${capa||'ë¯¸ì…ë ¥'}</div></div>
                <div class="row-item"><div class="rl">ì´ë²¤íŠ¸ ê¸°ê°„</div><div class="rv">${item[6]||'-'}</div></div>
                <div class="row-item"><div class="rl">ì‚¬ìœ </div><div class="rv">${item[7]||'-'}</div></div>
                <div class="row-item" style="flex-direction:column;border-bottom:none">
                    <div class="rl" style="margin-bottom:6px">ì½”ë©˜íŠ¸</div>
                    <div class="cmt-box">${comment || '<span style="color:#ccc">ì—†ìŒ</span>'}</div>
                </div>
            </div>`;
        }).join('');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // â”€â”€ ICIS ì…ë ¥ ëª¨ë‹¬ (ì‹ ê·œ ì €ì¥)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // ëª¨ë‹¬ ì—´ê¸° â€” ì¸ì¦ ìƒíƒœ í™•ì¸ í›„ í™”ë©´ ë¶„ê¸°
    function openModal() {
        parsed = null;
        document.getElementById('icis-input').value = '';
        document.getElementById('pv-wrap').style.display = 'none';
        document.getElementById('btn-save').style.display = 'none';
        if (!authed) {
            document.getElementById('auth-screen').style.display = 'block';
            document.getElementById('input-screen').style.display = 'none';
            document.getElementById('pw-input').value = '';
            document.getElementById('pw-err').style.display = 'none';
            document.getElementById('btn-parse').style.display = 'none';
        } else {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('input-screen').style.display = 'block';
            document.getElementById('btn-parse').style.display = 'block';
        }
        document.getElementById('overlay').classList.add('open');
        if (!authed) setTimeout(() => document.getElementById('pw-input').focus(), 100);
    }

    function closeModal() { document.getElementById('overlay').classList.remove('open'); }

    // ë¹„ë°€ë²ˆí˜¸ ì¸ì¦ (ì…ë ¥ ëª¨ë‹¬ìš©)
    function verifyPw() {
        if (document.getElementById('pw-input').value === ADMIN_PW) {
            authed = true;
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('input-screen').style.display = 'block';
            document.getElementById('btn-parse').style.display = 'block';
            setTimeout(() => document.getElementById('icis-input').focus(), 100);
        } else {
            document.getElementById('pw-err').style.display = 'block';
            document.getElementById('pw-input').value = '';
            document.getElementById('pw-input').focus();
        }
    }

    // â”€â”€ í‚¤ ì¶”ì¶œ í—¬í¼ (ë‹¤ì¤‘ í´ë°± í‚¤ ì§€ì›) â”€â”€
    function xf(text, ...keys) {
        for (const key of keys) {
            const esc = key.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const m   = text.match(new RegExp(esc + '[^:\\r\\n]*:\\s*([^\\r\\n]+)', 'i'));
            if (m) return m[1].trim();
        }
        return '-';
    }

    // â”€â”€ ICIS í…ìŠ¤íŠ¸ íŒŒì‹± â”€â”€
    function doParse() {
        const raw = document.getElementById('icis-input').value.trim();
        if (!raw) { toast('í…ìŠ¤íŠ¸ë¥¼ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”.', 'er'); return; }

        const company  = xf(raw, 'Name', 'Owner', 'Producer');
        const location = xf(raw, 'Location', 'Plant location');
        const product  = xf(raw, 'Product', 'Commodity', 'Products');
        const capa     = xf(raw, 'Capacity', 'Capacity (tonnes/year)', 'Capacity (mt/year)');
        const start    = xf(raw, 'Event start', 'Start', 'Start date');
        const finish   = xf(raw, 'Event finish', 'Finish', 'End date', 'Expected restart');
        const reason   = xf(raw, 'Reason', 'Type', 'Cause');
        const comment  = xf(raw, 'Comments', 'Notes', 'Note', 'Comment');

        const lo = raw.toLowerCase();
        const status = lo.includes('shutdown')        ? 'Shutdown'
                     : lo.includes('run cut')          ? 'Run Cut'
                     : lo.includes('restart')          ? 'Restart'
                     : lo.includes('no turnaround')    ? 'Maintenance'
                     : 'Maintenance';

        const period = (start !== '-' || finish !== '-') ? `${start} ~ ${finish}` : '-';
        const capaOk = capa !== '-';
        const allOk  = [company, location, product, capa].every(v => v !== '-');

        // ê¸°ì‚¬ ë°œí–‰ì¼ ì¶”ì¶œ â€” í˜•ì‹1: "16-Feb-26 11:10" / í˜•ì‹2: "2026-02-10 15:58"
        const fmt1 = raw.match(/(\d{1,2}-(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)-\d{2})\s+(\d{2}:\d{2})/i);
        const fmt2 = raw.match(/(\d{4}-\d{2}-\d{2})\s+(\d{2}:\d{2})/);
        const articleDate = fmt1 ? `${fmt1[1]} ${fmt1[2]}`
                          : fmt2 ? `${fmt2[1]} ${fmt2[2]}`
                          : '-';

        parsed = { company, location, product, capa, status, period, start, finish, reason, comment, articleDate, raw };

        document.getElementById('pg').innerHTML = buildFormHtml({
            company, location, product, capa, status, reason, start, finish, articleDate, comment, capaOk,
            idPrefix: 'ed'
        });

        const b = document.getElementById('pbadge');
        b.textContent = capaOk ? 'âœ… íŒŒì‹± ì™„ë£Œ' : 'âš ï¸ ì¼€íŒŒ ë¯¸ì¸ì‹ â€” ì§ì ‘ ì…ë ¥';
        b.className   = `pbadge ${capaOk ? 'pb-ok' : 'pb-warn'}`;
        document.getElementById('pv-wrap').style.display = 'block';
        document.getElementById('btn-save').style.display = 'block';
        toast(allOk ? 'íŒŒì‹± ì™„ë£Œ! ë‚´ìš© í™•ì¸ í›„ ì €ì¥í•˜ì„¸ìš”.' : 'âš ï¸ ì¼ë¶€ í•„ë“œ ë¯¸ì¸ì‹ â€” ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”.', allOk ? 'ok' : 'inf');
    }

    // â”€â”€ ê³µí†µ í¼ HTML ìƒì„± (ì‹ ê·œ ì €ì¥ íŒŒì‹±ê²°ê³¼ + Edit ëª¨ë‹¬ì—ì„œ ì¬ì‚¬ìš©) â”€â”€
    // idPrefix: 'ed' = ì‹ ê·œì…ë ¥ ëª¨ë‹¬, 'edt' = Edit ëª¨ë‹¬
    function buildFormHtml({ company, location, product, capa, status, reason, start, finish, articleDate, comment, capaOk, idPrefix }) {
        return `
            <div class="pf"><div class="pl">ì—…ì²´ëª… *</div><input class="pv-input hi" id="${idPrefix}-company"  value="${esc(company)}"></div>
            <div class="pf"><div class="pl">ì§€ì—­ *</div><input class="pv-input"    id="${idPrefix}-location" value="${esc(location)}"></div>
            <div class="pf"><div class="pl">í’ˆëª© *</div><input class="pv-input"    id="${idPrefix}-product"  value="${esc(product)}"></div>
            <div class="pf ${capaOk ? 'capa-ok' : 'capa-miss'}">
                <div class="pl">ì¼€íŒŒ ${capaOk ? 'âœ…' : 'âš ï¸ ì§ì ‘ ì…ë ¥'}</div>
                <input class="pv-input ${capaOk ? 'hi' : 'er'}" id="${idPrefix}-capa" value="${esc(capa)}">
            </div>
            <div class="pf">
                <div class="pl">ìƒíƒœ</div>
                <select class="pv-input" id="${idPrefix}-status">
                    <option ${status==='Shutdown'?'selected':''}>Shutdown</option>
                    <option ${status==='Run Cut'?'selected':''}>Run Cut</option>
                    <option ${status==='Maintenance'?'selected':''}>Maintenance</option>
                    <option ${status==='Restart'?'selected':''}>Restart</option>
                </select>
            </div>
            <div class="pf"><div class="pl">ì‚¬ìœ </div><input class="pv-input" id="${idPrefix}-reason" value="${esc(reason)}"></div>
            <div class="pf"><div class="pl">Event start</div><input class="pv-input" id="${idPrefix}-start"  value="${esc(start)}"></div>
            <div class="pf"><div class="pl">Event finish</div><input class="pv-input" id="${idPrefix}-finish" value="${esc(finish)}"></div>
            <div class="pf"><div class="pl">ê¸°ì‚¬ ë°œí–‰ì¼ ğŸ“°</div><input class="pv-input hi" id="${idPrefix}-articledate" value="${esc(articleDate)}"></div>
            <div class="pf full"><div class="pl">ì½”ë©˜íŠ¸</div><textarea class="pv-input pv-ta" id="${idPrefix}-comment">${comment !== '-' ? esc(comment) : ''}</textarea></div>`;
    }

    // HTML íŠ¹ìˆ˜ë¬¸ì ì´ìŠ¤ì¼€ì´í”„ í—¬í¼
    function esc(v) {
        if (!v || v === '-') return '';
        return String(v)
            .replace(/&/g,'&amp;')
            .replace(/"/g,'&quot;')
            .replace(/</g,'&lt;')
            .replace(/>/g,'&gt;');
    }

    // â”€â”€ ì‹ ê·œ ì €ì¥ ì‹¤í–‰ â”€â”€
    async function doSave() {
        if (!parsed) { toast('ë¨¼ì € íŒŒì‹±í•˜ì„¸ìš”.', 'er'); return; }

        // ìˆ˜ì •ëœ input ê°’ ì½ê¸°
        const company     = document.getElementById('ed-company').value.trim();
        const location    = document.getElementById('ed-location').value.trim();
        const product     = document.getElementById('ed-product').value.trim();
        const capa        = document.getElementById('ed-capa').value.trim();
        const status      = document.getElementById('ed-status').value;
        const reason      = document.getElementById('ed-reason').value.trim();
        const start       = document.getElementById('ed-start').value.trim();
        const finish      = document.getElementById('ed-finish').value.trim();
        const articleDate = document.getElementById('ed-articledate').value.trim();
        const comment     = document.getElementById('ed-comment').value.trim();
        const period      = (start || finish) ? `${start} ~ ${finish}` : '-';

        if (!company)     { toast('ì—…ì²´ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.', 'er'); return; }
        if (!articleDate) { toast('ê¸°ì‚¬ ë°œí–‰ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.', 'er'); return; }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ì¤‘ë³µ ì²´í¬: ì—…ì²´ëª…(ëŒ€ì†Œë¬¸ì ë¬´ì‹œ) + ê¸°ì‚¬ë°œí–‰ì¼(ë‚ ì§œ+ì‹œê°„ ì „ì²´) ì™„ì „ ì¼ì¹˜
        // ì´ì „ ë²„ì „ì˜ ë‚ ì§œë§Œ ë¹„êµ ë°©ì‹ì„ ë‚ ì§œ+ì‹œê°„ ì „ì²´ ë¬¸ìì—´ ë¹„êµë¡œ ê°•í™”
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const isDup = db.some(row => {
            const rowCompany = (row[1] || '').toString().trim().toLowerCase();
            const rowDate    = row[0] ? String(row[0]).trim() : '';
            // ì—…ì²´ëª… ì™„ì „ ì¼ì¹˜ AND ë‚ ì§œ+ì‹œê°„ ë¬¸ìì—´ í¬í•¨ ì—¬ë¶€
            return rowCompany === company.toLowerCase() &&
                   rowDate.includes(articleDate.trim());
        });
        if (isDup) {
            toast(`âš ï¸ ì¤‘ë³µ â€” ${company} / ${articleDate} ì´ë¯¸ ì €ì¥ë¨`, 'inf', 5000);
            return;
        }

        const btn = document.getElementById('btn-save');
        btn.textContent = 'ì €ì¥ ì¤‘...'; btn.disabled = true;
        try {
            const res = await fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({
                    action: 'saveIcis',
                    data: { date: articleDate, company, location, product, capa, status, period, reason, comment, raw: parsed.raw }
                })
            });
            const r = await res.json();
            if (r.success) {
                toast('âœ… ì €ì¥ ì™„ë£Œ! ' + company, 'ok', 4000);
                closeModal();
                // í˜„ì¬ í•„í„° ìƒíƒœ ë³´ì¡´í•˜ì—¬ ì¬ì¡°íšŒ
                const curP = document.getElementById('pSelect').value;
                const curC = document.getElementById('cSelect').value;
                const curR = document.getElementById('rSelect').value;
                await init();
                if (curP) {
                    document.getElementById('pSelect').value = curP;
                    updateComp();
                    if (curC) document.getElementById('cSelect').value = curC;
                    if (curR) document.getElementById('rSelect').value = curR;
                    renderCards(curP, curC, curR);
                }
            } else {
                toast('ì €ì¥ ì‹¤íŒ¨: ' + (r.message || 'ì˜¤ë¥˜'), 'er');
            }
        } catch(e) {
            toast('âŒ ì˜¤ë¥˜: ' + e.message, 'er');
        } finally {
            btn.textContent = 'ğŸ’¾ êµ¬ê¸€ì‹œíŠ¸ ì €ì¥'; btn.disabled = false;
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // â”€â”€ Edit ëª¨ë‹¬ (ê¸°ì¡´ ë ˆì½”ë“œ ìˆ˜ì •)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // Edit ëª¨ë‹¬ ì—´ê¸° â€” currentRows[idx] ë¥¼ í¼ì— ì‚¬ì „ ì…ë ¥
    function openEditModal(idx) {
        const item = currentRows[idx];
        if (!item) { toast('ë ˆì½”ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'er'); return; }

        // ìˆ˜ì • ëŒ€ìƒ ì €ì¥ (í–‰ ì‹ë³„ìš© ì›ë³¸ í‚¤ ë³´ê´€)
        editTarget = {
            rowData:         item,
            originalDate:    item[0] ? String(item[0]).trim() : '', // Aì—´ ì›ë³¸ ë‚ ì§œ(ë‚ ì§œ+ì‹œê°„)
            originalCompany: item[1] ? String(item[1]).trim() : ''  // Bì—´ ì›ë³¸ ì—…ì²´ëª…
        };

        // ì¸ì¦ í™”ë©´ ë¶„ê¸°
        if (!authed) {
            document.getElementById('edit-auth-screen').style.display = 'block';
            document.getElementById('edit-form-screen').style.display = 'none';
            document.getElementById('edit-pw-input').value = '';
            document.getElementById('edit-pw-err').style.display = 'none';
        } else {
            populateEditForm(item);
        }
        document.getElementById('edit-overlay').classList.add('open');
        if (!authed) setTimeout(() => document.getElementById('edit-pw-input').focus(), 100);
    }

    function closeEditModal() {
        document.getElementById('edit-overlay').classList.remove('open');
        editTarget = null;
    }

    // Edit ëª¨ë‹¬ ë¹„ë°€ë²ˆí˜¸ ì¸ì¦ (authed ê³µìœ  â€” í•œ ë²ˆ ì¸ì¦í•˜ë©´ ë‘ ëª¨ë‹¬ ëª¨ë‘ ì—´ë¦¼)
    function verifyEditPw() {
        if (document.getElementById('edit-pw-input').value === ADMIN_PW) {
            authed = true;
            document.getElementById('edit-auth-screen').style.display = 'none';
            if (editTarget) populateEditForm(editTarget.rowData);
        } else {
            document.getElementById('edit-pw-err').style.display = 'block';
            document.getElementById('edit-pw-input').value = '';
            document.getElementById('edit-pw-input').focus();
        }
    }

    // Edit í¼ì— ê¸°ì¡´ ë°ì´í„° ì±„ìš°ê¸°
    function populateEditForm(item) {
        document.getElementById('edit-form-screen').style.display = 'block';
        document.getElementById('edit-auth-screen').style.display = 'none';

        // ë‚ ì§œ í¬ë§· â€” ì‹œíŠ¸ì—ì„œ ê°€ì ¸ì˜¨ ê°’ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš© (ë¬¸ìì—´ or Date ê°ì²´ ëª¨ë‘ ì²˜ë¦¬)
        let rawDate = item[0] ? String(item[0]).trim() : '-';

        // ê¸°ì¡´ ì´ë²¤íŠ¸ ê¸°ê°„(Gì—´=index 6)ì—ì„œ start/finish ë¶„ë¦¬
        const periodStr = item[6] ? String(item[6]) : '';
        const periodParts = periodStr.split('~').map(s => s.trim());
        const start  = periodParts[0] || '-';
        const finish = periodParts[1] || '-';

        const company  = item[1] ? String(item[1]).trim() : '-';
        const location = item[2] ? String(item[2]).trim() : '-';
        const product  = item[3] ? String(item[3]).trim() : '-';
        const capa     = item[4] ? String(item[4]).trim() : '-';
        const status   = item[5] ? String(item[5]).trim() : 'Maintenance';
        const reason   = item[7] ? String(item[7]).trim() : '-';
        const comment  = item[8] ? String(item[8]).trim() : '-';
        const capaOk   = capa !== '-' && capa !== '';

        // ë°°ë„ˆì— í˜„ì¬ ë ˆì½”ë“œ ìš”ì•½ í‘œì‹œ
        document.getElementById('edit-banner').innerHTML =
            `<strong>ğŸ“Œ ìˆ˜ì • ëŒ€ìƒ</strong> &nbsp; ${company} &nbsp;|&nbsp; ${rawDate} &nbsp;|&nbsp; ${product}`;

        // í¼ í•„ë“œ ìƒì„± (idPrefix='edt' ë¡œ ì‹ ê·œì €ì¥ ëª¨ë‹¬ í•„ë“œì™€ ì¶©ëŒ ë°©ì§€)
        document.getElementById('edit-pg').innerHTML = buildFormHtml({
            company, location, product, capa, status, reason,
            start, finish, articleDate: rawDate, comment, capaOk,
            idPrefix: 'edt'
        });
    }

    // â”€â”€ Edit ìˆ˜ì • ì €ì¥ ì‹¤í–‰ â”€â”€
    async function doUpdate() {
        if (!editTarget) { toast('ìˆ˜ì • ëŒ€ìƒì´ ì—†ìŠµë‹ˆë‹¤.', 'er'); return; }

        // í¼ì—ì„œ ìµœì‹  ê°’ ì½ê¸°
        const company     = document.getElementById('edt-company').value.trim();
        const location    = document.getElementById('edt-location').value.trim();
        const product     = document.getElementById('edt-product').value.trim();
        const capa        = document.getElementById('edt-capa').value.trim();
        const status      = document.getElementById('edt-status').value;
        const reason      = document.getElementById('edt-reason').value.trim();
        const start       = document.getElementById('edt-start').value.trim();
        const finish      = document.getElementById('edt-finish').value.trim();
        const articleDate = document.getElementById('edt-articledate').value.trim();
        const comment     = document.getElementById('edt-comment').value.trim();
        const period      = (start || finish) ? `${start} ~ ${finish}` : '-';

        if (!company)     { toast('ì—…ì²´ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.', 'er'); return; }
        if (!articleDate) { toast('ê¸°ì‚¬ ë°œí–‰ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.', 'er'); return; }

        const btn = document.getElementById('btn-update');
        btn.textContent = 'ì €ì¥ ì¤‘...'; btn.disabled = true;
        try {
            const res = await fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({
                    action: 'editIcis',
                    // rowKey: GASì—ì„œ í–‰ ì‹ë³„ì— ì‚¬ìš© â€” ì›ë³¸ ë‚ ì§œ+ì‹œê°„ & ì›ë³¸ ì—…ì²´ëª…
                    rowKey: {
                        date:    editTarget.originalDate,
                        company: editTarget.originalCompany
                    },
                    data: { date: articleDate, company, location, product, capa, status, period, reason, comment }
                })
            });
            const r = await res.json();
            if (r.success) {
                toast('âœ… ìˆ˜ì • ì™„ë£Œ! ' + company, 'ok', 4000);
                closeEditModal();
                // í˜„ì¬ í•„í„° ìƒíƒœ ë³´ì¡´í•˜ì—¬ ì¬ì¡°íšŒ
                const curP = document.getElementById('pSelect').value;
                const curC = document.getElementById('cSelect').value;
                const curR = document.getElementById('rSelect').value;
                await init();
                if (curP) {
                    document.getElementById('pSelect').value = curP;
                    updateComp();
                    if (curC) document.getElementById('cSelect').value = curC;
                    if (curR) document.getElementById('rSelect').value = curR;
                    renderCards(curP, curC, curR);
                }
            } else {
                toast('ìˆ˜ì • ì‹¤íŒ¨: ' + (r.message || 'ì˜¤ë¥˜'), 'er');
            }
        } catch(e) {
            toast('âŒ ì˜¤ë¥˜: ' + e.message, 'er');
        } finally {
            btn.textContent = 'âœ… ìˆ˜ì • ì €ì¥'; btn.disabled = false;
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // â”€â”€ í† ìŠ¤íŠ¸ ì•Œë¦¼
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function toast(msg, type='inf', ms=3400) {
        const t = document.getElementById('toast');
        t.textContent = msg; t.className = `show ${type}`;
        clearTimeout(t._t);
        t._t = setTimeout(() => t.className = '', ms);
    }

    // â”€â”€ ESC / ë°°ê²½ í´ë¦­ìœ¼ë¡œ ëª¨ë‹¬ ë‹«ê¸° â”€â”€
    document.addEventListener('keydown', e => {
        if (e.key === 'Escape') { closeModal(); closeEditModal(); }
    });
    document.getElementById('overlay').addEventListener('click', e => {
        if (e.target === document.getElementById('overlay')) closeModal();
    });
    document.getElementById('edit-overlay').addEventListener('click', e => {
        if (e.target === document.getElementById('edit-overlay')) closeEditModal();
    });

    // â”€â”€ í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ì¡°íšŒ â”€â”€
    init();
</script>

</body>
</html>
